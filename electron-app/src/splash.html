<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cupcake Vanilla - Starting</title>

    <!-- Import local splash CSS with Bootstrap and themes -->
    <link href="splash.css" rel="stylesheet">
</head>
<body>
    <div class="splash-container">
        <div class="titlebar" id="titlebar">
            <div class="window-controls" id="window-controls">
                <!-- Controls will be dynamically inserted based on OS -->
            </div>
        </div>

        <div class="header">
            <div class="logo">üßÅ Cupcake Vanilla</div>
            <div class="subtitle">Starting backend services...</div>
        </div>

        <div class="progress-section">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div id="progress-text" class="progress-text">Starting...</div>
        </div>

        <div class="log-section">
            <div class="log-header">Process Logs</div>
            <div id="log-output" class="log-output"></div>
        </div>

        <button id="continue-btn" class="continue-btn">Continue to Application</button>
    </div>

    <script>
        console.log('Splash screen script starting...');

        const themes = ['basic', 'default', 'scifi', 'matrix', 'space'];
        const selectedTheme = themes[Math.floor(Math.random() * themes.length)];
        document.body.className = `theme-${selectedTheme}`;
        console.log(`Selected theme: ${selectedTheme}`);

        const platform = window.electronAPI ? window.electronAPI.platform : 'win32';
        console.log('Detected platform:', platform);

        const titlebar = document.getElementById('titlebar');
        const windowControls = document.getElementById('window-controls');

        function setupWindowControls() {
            if (platform === 'darwin') {
                titlebar.className = 'titlebar macos';
                windowControls.innerHTML = `
                    <div class="window-control close" id="close-btn"></div>
                    <div class="window-control minimize" id="minimize-btn"></div>
                `;
            } else if (platform === 'win32') {
                // Windows style
                titlebar.className = 'titlebar windows';
                windowControls.innerHTML = `
                    <div class="window-control minimize" id="minimize-btn">‚Äí</div>
                    <div class="window-control close" id="close-btn">‚úï</div>
                `;
            } else {
                // Linux/other style
                titlebar.className = 'titlebar linux';
                windowControls.innerHTML = `
                    <div class="window-control minimize" id="minimize-btn">‚Äí</div>
                    <div class="window-control close" id="close-btn">‚úï</div>
                `;
            }
        }

        setupWindowControls();

        let totalServices = 7;
        let readyServices = 0;
        let completedServices = new Set();

        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const continueBtn = document.getElementById('continue-btn');
        const logOutput = document.getElementById('log-output');

        function updateProgress() {
            const progress = Math.round((readyServices / totalServices) * 100);
            progressFill.style.width = progress + '%';

            if (readyServices === 0) {
                progressText.textContent = '0% - Starting...';
            } else if (readyServices === totalServices) {
                progressText.textContent = '100% - Ready';
                continueBtn.classList.add('show');
            } else {
                progressText.textContent = `${progress}% - ${readyServices}/${totalServices} services ready`;
            }
        }

        function addLogMessage(message, type = 'info') {
            document.querySelector('.log-section').style.display = 'block';
            const logLine = document.createElement('div');
            logLine.className = `log-line ${type}`;
            logLine.textContent = message;
            logOutput.appendChild(logLine);

            logOutput.scrollTop = logOutput.scrollHeight;

            if (logOutput.children.length > 1000) {
                logOutput.removeChild(logOutput.firstChild);
            }
        }

        function updateServiceStatus(service, status, message) {
            const timestamp = new Date().toLocaleTimeString();

            if (status === 'starting') {
                addLogMessage(`[${timestamp}] [${service.toUpperCase()}] Starting...`, 'info');
            } else if (status === 'ready' || status === 'error') {
                if (!completedServices.has(service)) {
                    completedServices.add(service);
                    readyServices++;

                    if (status === 'ready') {
                        addLogMessage(`[${timestamp}] [${service.toUpperCase()}] Ready`, 'success');
                    } else {
                        addLogMessage(`[${timestamp}] [${service.toUpperCase()}] ${message}`, 'warning');
                    }
                    updateProgress();
                } else {
                    if (status === 'ready') {
                        addLogMessage(`[${timestamp}] [${service.toUpperCase()}] Ready (already counted)`, 'info');
                    } else {
                        addLogMessage(`[${timestamp}] [${service.toUpperCase()}] ${message} (already counted)`, 'info');
                    }
                }
            }
        }

        // Set up event listeners using the secure API
        if (window.electronAPI) {
            console.log('Setting up secure Electron API listeners...');

            // Backend status updates
            window.electronAPI.onBackendStatus((event, data) => {
                console.log('Received backend status:', data);
                const { service, status, message } = data;
                updateServiceStatus(service, status, message);
            });

            // Backend log messages
            window.electronAPI.onBackendLog((event, data) => {
                console.log('Received backend log:', data);
                const { message, type = 'info' } = data;
                const timestamp = new Date().toLocaleTimeString();
                addLogMessage(`[${timestamp}] ${message}`, type);
            });

            // Handle continue button
            continueBtn.addEventListener('click', () => {
                window.electronAPI.continueToApp();
            });

            // Handle window controls (set up after DOM is ready)
            setTimeout(() => {
                const closeBtn = document.getElementById('close-btn');
                const minimizeBtn = document.getElementById('minimize-btn');

                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        window.electronAPI.closeSplash();
                    });
                }

                if (minimizeBtn) {
                    minimizeBtn.addEventListener('click', () => {
                        window.electronAPI.minimizeSplash();
                    });
                }
            }, 100);

            console.log('Electron API listeners set up successfully');
        } else {
            console.warn('Electron API not available - running in fallback mode');
            // Fallback for when Electron API is not available
            continueBtn.addEventListener('click', () => {
                console.log('Continue clicked (fallback mode)');
                alert('Continue button clicked - Electron API not available');
            });
        }

        // Initialize
        updateProgress();
        addLogMessage('Starting Cupcake Vanilla backend services...', 'info');

        // Verify theme is applied
        console.log('Theme applied:', document.body.className);
    </script>
</body>
</html>
