<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Downloading...</title>
  <link rel="stylesheet" href="downloader-panel.css">
</head>
<body>
  <div class="downloader-container">
    <div class="downloader-header">
      <h5 id="download-title" class="mb-0">Downloading...</h5>
    </div>

    <div style="padding: 0.75rem;">
      <div style="margin-bottom: 0.75rem;">
        <div class="d-flex justify-content-between align-items-center" style="margin-bottom: 0.5rem;">
          <small id="progress-text" class="text-muted">Initializing...</small>
          <small id="progress-percentage" class="fw-bold">0%</small>
        </div>
        <div class="progress" style="height: 4px;">
          <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
               role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          </div>
        </div>
        <div class="d-flex justify-content-between" style="margin-top: 0.25rem;">
          <small id="download-size" class="text-muted" style="font-size: 0.7rem;">0 MB / 0 MB</small>
          <small id="download-speed" class="text-muted" style="font-size: 0.7rem;">0 KB/s</small>
        </div>
      </div>

      <div style="margin-bottom: 0.75rem;">
        <div id="status-message" class="status-message" style="font-size: 0.8rem; padding: 0.5rem; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
          Ready to download
        </div>
      </div>

      <div class="d-flex justify-content-end">
        <button id="cancel-btn" class="btn btn-sm btn-secondary" style="font-size: 0.8rem; padding: 0.25rem 0.75rem;">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <script>
    // UI update handlers
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressPercentage = document.getElementById('progress-percentage');
    const downloadSize = document.getElementById('download-size');
    const downloadSpeed = document.getElementById('download-speed');
    const statusMessage = document.getElementById('status-message');
    const cancelBtn = document.getElementById('cancel-btn');

    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    }

    function formatSpeed(bytesPerSecond) {
      return formatBytes(bytesPerSecond) + '/s';
    }

    if (window.downloaderAPI) {
      // Progress updates
      window.downloaderAPI.onProgress((progress) => {
        progressBar.style.width = progress.percentage + '%';
        progressBar.setAttribute('aria-valuenow', progress.percentage);
        progressPercentage.textContent = progress.percentage + '%';
        progressText.textContent = 'Downloading...';

        downloadSize.textContent = formatBytes(progress.downloaded) + ' / ' + formatBytes(progress.total);
        downloadSpeed.textContent = formatSpeed(progress.speed);
      });

      // Status updates
      window.downloaderAPI.onStatus((status) => {
        statusMessage.textContent = status.message;
        statusMessage.className = 'alert status-message';

        switch (status.type) {
          case 'success':
            statusMessage.classList.add('alert-success');
            break;
          case 'error':
            statusMessage.classList.add('alert-danger');
            break;
          case 'warning':
            statusMessage.classList.add('alert-warning');
            break;
          default:
            statusMessage.classList.add('alert-secondary');
        }
      });

      // Completion
      window.downloaderAPI.onComplete((success, message) => {
        progressText.textContent = success ? 'Complete' : 'Failed';
        statusMessage.textContent = message;
        statusMessage.className = 'alert status-message';
        statusMessage.classList.add(success ? 'alert-success' : 'alert-danger');

        cancelBtn.textContent = 'Close';
        progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');

        if (success) {
          progressBar.style.width = '100%';
          progressPercentage.textContent = '100%';

          // Auto-close after 2 seconds on success
          setTimeout(() => {
            window.close();
          }, 2000);
        }
      });

      // Button handlers
      cancelBtn.addEventListener('click', () => {
        window.downloaderAPI.cancel();
      });
    }
  </script>
</body>
</html>