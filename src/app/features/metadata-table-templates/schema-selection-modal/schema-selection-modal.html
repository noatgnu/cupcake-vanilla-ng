<div class="modal-header">
  <h4 class="modal-title">
    <i class="bi bi-file-earmark-plus me-2"></i>Create Template from Schemas
  </h4>
  <button 
    type="button" 
    class="btn-close" 
    aria-label="Close"
    (click)="onCancel()">
  </button>
</div>

<div class="modal-body">
  <form [formGroup]="templateForm" class="needs-validation" novalidate>
    <!-- Template Basic Information -->
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="bi bi-info-circle me-1"></i>Template Information
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-12 mb-3">
            <div class="form-floating">
              <input 
                type="text" 
                class="form-control"
                [class.is-invalid]="templateForm.get('name')?.invalid && templateForm.get('name')?.touched"
                id="templateName" 
                formControlName="name"
                placeholder="Enter template name">
              <label for="templateName">Template Name *</label>
              @if (templateForm.get('name')?.invalid && templateForm.get('name')?.touched) {
                <div class="invalid-feedback">
                  Template name is required.
                </div>
              }
            </div>
          </div>
          <div class="col-12 mb-3">
            <div class="form-floating">
              <textarea 
                class="form-control" 
                id="templateDescription" 
                formControlName="description"
                style="height: 80px"
                placeholder="Enter template description">
              </textarea>
              <label for="templateDescription">Description</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Schema Selection -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="bi bi-check2-square me-1"></i>Select Schemas
        </h6>
        <small class="text-muted">{{ selectedSchemasCount() }} selected</small>
      </div>
      <div class="card-body">
        @if (availableSchemas.length === 0) {
          <div class="text-center text-muted py-3">
            <i class="bi bi-exclamation-triangle fs-4 d-block mb-2"></i>
            No schemas available
          </div>
        } @else {
          <div class="row">
            @for (schema of availableSchemas; track schema.id) {
              <div class="col-md-6 mb-2">
                <div class="card schema-card" 
                     [class.selected]="isSchemaSelected(schema.id)"
                     (click)="toggleSchema(schema.id)">
                  <div class="card-body p-3">
                    <div class="form-check">
                      <input 
                        class="form-check-input" 
                        type="checkbox"
                        [id]="'schema-' + schema.id"
                        [checked]="isSchemaSelected(schema.id)"
                        (change)="onSchemaCheckChange($event, schema.id)">
                      <label class="form-check-label w-100" [for]="'schema-' + schema.id">
                        <div class="d-flex justify-content-between align-items-start">
                          <div class="flex-grow-1">
                            <strong class="schema-title">{{ schema.display_name }}</strong>
                            @if (schema.description) {
                              <p class="schema-description text-muted small mb-1">
                                {{ schema.description }}
                              </p>
                            }
                            <div class="schema-metadata">
                              @if (schema.tags && schema.tags.length > 0) {
                                @for (tag of schema.tags; track tag) {
                                  <span class="badge bg-secondary me-1">{{ tag }}</span>
                                }
                              }
                              @if (schema.usage_count > 0) {
                                <small class="text-muted">
                                  <i class="bi bi-graph-up me-1"></i>{{ schema.usage_count }} uses
                                </small>
                              }
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
          
          @if (selectedSchemasCount() === 0) {
            <div class="alert alert-warning mt-3" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Please select at least one schema to create a template.
            </div>
          }
        }
      </div>
    </div>

    <!-- Template Settings -->
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="bi bi-gear me-1"></i>Template Settings
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="form-floating">
              <select 
                class="form-select" 
                id="labGroup" 
                formControlName="lab_group_id">
                <option [ngValue]="null">No Lab Group</option>
                @for (group of labGroups; track group.id) {
                  <option [ngValue]="group.id">{{ group.name }}</option>
                }
              </select>
              <label for="labGroup">Lab Group</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check form-switch mb-3">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="isPublic" 
                formControlName="is_public">
              <label class="form-check-label" for="isPublic">
                <i class="bi bi-globe me-1"></i>Make Public
              </label>
            </div>
            <div class="form-check form-switch">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="isDefault" 
                formControlName="is_default">
              <label class="form-check-label" for="isDefault">
                <i class="bi bi-star me-1"></i>Set as Default
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Preview Section -->
    @if (selectedSchemasCount() > 0) {
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="bi bi-eye me-1"></i>Selected Schemas Preview
          </h6>
        </div>
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2">
            @for (schemaId of getSelectedSchemas(); track schemaId) {
              <span class="badge bg-primary fs-6 py-2 px-3">
                {{ getSchemaDisplayName(schemaId) }}
                <button 
                  type="button" 
                  class="btn-close btn-close-white ms-2"
                  style="font-size: 0.6em;"
                  (click)="removeSchema(schemaId)"
                  [attr.aria-label]="'Remove ' + getSchemaDisplayName(schemaId)">
                </button>
              </span>
            }
          </div>
          <p class="text-muted small mt-2 mb-0">
            This template will combine columns from {{ selectedSchemasCount() }} schema{{ selectedSchemasCount() === 1 ? '' : 's' }}.
          </p>
        </div>
      </div>
    }
  </form>
</div>

<div class="modal-footer">
  <button 
    type="button" 
    class="btn btn-outline-secondary" 
    (click)="onCancel()">
    <i class="bi bi-x-circle me-1"></i>Cancel
  </button>
  <button 
    type="button" 
    class="btn btn-primary"
    [disabled]="!canCreateTemplate()"
    (click)="onCreateTemplate()">
    <i class="bi bi-plus-circle me-1"></i>Create Template
  </button>
</div>