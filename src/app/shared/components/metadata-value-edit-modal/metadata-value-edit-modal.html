<div class="modal-header">
  <h4 class="modal-title">
    <i class="bi bi-pencil-square me-2"></i>{{ title }}
  </h4>
  <button type="button" class="btn-close" (click)="onCancel()"></button>
</div>

<div class="modal-body">
  <form [formGroup]="editForm" (ngSubmit)="onSubmit()">

    <!-- Column Information -->
    <div class="mb-3">
      <div class="row">
        <div class="col-md-6">
          <small class="text-muted">Column Name:</small>
          <div class="fw-semibold">{{ config.columnName }}</div>
        </div>
        <div class="col-md-6">
          <small class="text-muted">Column Type:</small>
          <div><span class="badge bg-light text-dark">{{ config.columnType }}</span></div>
        </div>
      </div>
      @if (hasOntologyType) {
        <div class="mt-2">
          <small class="text-muted">Ontology Type:</small>
          <div><span class="badge bg-info">{{ ontologyTypeLabel }}</span></div>
        </div>
      }
    </div>

    <hr class="mb-4">

    <!-- Favorite Options Section -->
    @if (hasFavorites && !isLoadingFavorites()) {
      <div class="mb-4">
        <h6 class="text-muted mb-3">
          <i class="bi bi-heart-fill me-2 text-danger"></i>Recommended Values
        </h6>

        <!-- User Favorites -->
        @if (userFavorites().length > 0) {
          <div class="mb-3">
            <small class="text-muted d-block mb-2">
              <i class="bi bi-person-fill me-1"></i>Your Favorites
            </small>
            <div class="d-flex flex-wrap gap-1">
              @for (favorite of userFavorites(); track favorite.id) {
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm"
                  (click)="selectFavorite(favorite)"
                  [title]="getFavoriteTooltip(favorite)">
                  <i class="bi bi-person me-1"></i>
                  {{ getFavoriteDisplayValue(favorite) | slice:0:20 }}@if (getFavoriteDisplayValue(favorite).length > 20) {...}
                  @if (hasCustomDisplayValue(favorite)) {
                    <i class="bi bi-info-circle ms-1 text-info" title="Has custom display name"></i>
                  }
                </button>
              }
            </div>
          </div>
        }

        <!-- Lab Group Favorites -->
        @if (labGroupFavorites().length > 0) {
          <div class="mb-3">
            <small class="text-muted d-block mb-2">
              <i class="bi bi-people-fill me-1"></i>Lab Group Favorites
            </small>
            <div class="d-flex flex-wrap gap-1">
              @for (favorite of labGroupFavorites(); track favorite.id) {
                <button
                  type="button"
                  class="btn btn-outline-info btn-sm"
                  (click)="selectFavorite(favorite)"
                  [title]="getFavoriteTooltip(favorite)">
                  <i class="bi bi-people me-1"></i>
                  {{ getFavoriteDisplayValue(favorite) | slice:0:20 }}@if (getFavoriteDisplayValue(favorite).length > 20) {...}
                  @if (hasCustomDisplayValue(favorite)) {
                    <i class="bi bi-info-circle ms-1 text-info" title="Has custom display name"></i>
                  }
                </button>
              }
            </div>
          </div>
        }

        <!-- Global Favorites -->
        @if (globalFavorites().length > 0) {
          <div class="mb-3">
            <small class="text-muted d-block mb-2">
              <i class="bi bi-globe me-1"></i>Global Recommendations
            </small>
            <div class="d-flex flex-wrap gap-1">
              @for (favorite of globalFavorites(); track favorite.id) {
                <button
                  type="button"
                  class="btn btn-outline-success btn-sm"
                  (click)="selectFavorite(favorite)"
                  [title]="getFavoriteTooltip(favorite)">
                  <i class="bi bi-globe me-1"></i>
                  {{ getFavoriteDisplayValue(favorite) | slice:0:20 }}@if (getFavoriteDisplayValue(favorite).length > 20) {...}
                  @if (hasCustomDisplayValue(favorite)) {
                    <i class="bi bi-info-circle ms-1 text-info" title="Has custom display name"></i>
                  }
                </button>
              }
            </div>
          </div>
        }

        <hr class="my-3">
      </div>
    }

    @if (isLoadingFavorites()) {
      <div class="text-center mb-4">
        <div class="spinner-border spinner-border-sm text-primary me-2"></div>
        <small class="text-muted">Loading favorite options...</small>
      </div>
      <hr class="my-3">
    }

    <!-- Value Input Section -->
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <label for="metadataValue" class="form-label mb-0">
          Metadata Value
          @if (hasOntologyType) {
            <span class="badge bg-success ms-2">
              <i class="bi bi-search me-1"></i>Autocomplete Available
            </span>
          }
          @if (specialSyntaxType()) {
            <span class="badge bg-info ms-2">
              <i class="bi bi-gear me-1"></i>{{ getSpecialInputTitle() }}
            </span>
          }
        </label>

        @if (specialSyntaxType()) {
          <div class="form-check form-switch">
            <input
              class="form-check-input"
              type="checkbox"
              id="specialInputToggle"
              [checked]="showSpecialInput()"
              (change)="toggleSpecialInput()">
            <label class="form-check-label small text-muted" for="specialInputToggle">
              Enhanced Editor
            </label>
          </div>
        }
      </div>

      <!-- Special SDRF Syntax Input Components -->
      @if (showSpecialInput() && specialSyntaxType()) {
        <div class="border rounded p-3 mb-3 bg-light">
          <div class="mb-2">
            <small class="text-muted fw-semibold">
              <i class="bi bi-gear me-1"></i>{{ getSpecialInputTitle() }}
            </small>
          </div>

          @switch (specialSyntaxType()) {
            @case ('age') {
              <app-sdrf-age-input
                [value]="specialInputValue()"
                (valueChange)="onSpecialInputChange($event)">
              </app-sdrf-age-input>
            }
            @case ('modification') {
              <app-sdrf-modification-input
                [value]="specialInputValue()"
                [columnId]="config.columnId ?? null"
                [templateId]="config.templateId ?? null"
                (valueChange)="onSpecialInputChange($event)">
              </app-sdrf-modification-input>
            }
            @case ('cleavage') {
              <app-sdrf-cleavage-input
                [value]="specialInputValue()"
                [columnId]="config.columnId ?? null"
                [templateId]="config.templateId ?? null"
                (valueChange)="onSpecialInputChange($event)">
              </app-sdrf-cleavage-input>
            }
            @case ('spiked_compound') {
              <app-sdrf-spiked-compound-input
                [value]="specialInputValue()"
                (valueChange)="onSpecialInputChange($event)">
              </app-sdrf-spiked-compound-input>
            }
          }

          <div class="form-text mt-2">
            <i class="bi bi-info-circle me-1"></i>
            Use the enhanced editor for structured input, or toggle off for manual text entry.
          </div>
        </div>
      }

      @if (hasOntologyType && !showSpecialInput()) {
        <!-- Search type selection for ontology -->
        <div class="mb-2">
          <small class="text-muted d-block mb-1">Search Mode:</small>
          <div class="btn-group btn-group-sm" role="group">
            <button
              type="button"
              class="btn"
              [class]="searchType() === 'icontains' ? 'btn-primary' : 'btn-outline-primary'"
              (click)="onSearchTypeChange('icontains')">
              <i class="bi bi-search me-1"></i>Contains
            </button>
            <button
              type="button"
              class="btn"
              [class]="searchType() === 'istartswith' ? 'btn-primary' : 'btn-outline-primary'"
              (click)="onSearchTypeChange('istartswith')">
              <i class="bi bi-arrow-right me-1"></i>Starts with
            </button>
          </div>
        </div>

        <!-- Typeahead input for ontology suggestions -->
        <div class="input-group">
          <input
            type="text"
            class="form-control"
            [class.border-success]="selectedFavorite() !== null"
            id="metadataValue"
            formControlName="value"
            placeholder="Type to search ontology suggestions..."
            [ngbTypeahead]="searchOntology"
            [resultFormatter]="formatSuggestion"
            [inputFormatter]="formatSuggestion"
            (selectItem)="onSuggestionSelected($event)"
            [editable]="true"
            [showHint]="true"
            [focusFirst]="false"
            container="body">
          @if (isLoadingSuggestions()) {
            <span class="input-group-text">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </span>
          } @else {
            <span class="input-group-text">
              <i class="bi bi-search text-muted"></i>
            </span>
          }
          <button
            type="button"
            class="btn btn-outline-secondary"
            (click)="clearValue()"
            title="Clear value">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="form-text">
          <i class="bi bi-info-circle me-1"></i>
          Search {{ searchType() === 'icontains' ? 'contains' : 'starts with' }} for {{ ontologyTypeLabel }} ontology
        </div>
      } @else if (!showSpecialInput()) {
        <!-- Regular input when no ontology type or special input is disabled -->
        <div class="input-group">
          <input
            type="text"
            class="form-control"
            [class.border-success]="selectedFavorite() !== null"
            id="metadataValue"
            formControlName="value"
            placeholder="Enter metadata value">
          <button
            type="button"
            class="btn btn-outline-secondary"
            (click)="clearValue()"
            title="Clear value">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="form-text text-muted">
          @if (specialSyntaxType()) {
            Manual text entry mode. Use the Enhanced Editor toggle for structured {{ specialSyntaxType() }} input.
          } @else {
            Enter the value manually (no ontology suggestions available for this column type)
          }
        </div>
      }
    </div>

    <!-- Character count and value info -->
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted">
          Characters: {{ editForm.get('value')?.value?.length || 0 }}/500
        </small>
        @if (getSelectedFavoriteInfo()) {
          <small class="text-info">
            <i class="bi bi-info-circle me-1"></i>{{ getSelectedFavoriteInfo() }}
          </small>
        }
      </div>
    </div>

  </form>
</div>

<div class="modal-footer">
  <div class="me-auto">
    @if (editForm.get('value')?.value && !isLoading()) {
      <div class="btn-group dropup" ngbDropdown>
        <button
          type="button"
          class="btn btn-outline-warning btn-sm dropdown-toggle"
          ngbDropdownToggle>
          <i class="bi bi-heart me-1"></i>Add to Favorites
        </button>
        <div class="dropdown-menu" ngbDropdownMenu>
          <button
            type="button"
            class="dropdown-item"
            (click)="addToFavorites('user')">
            <i class="bi bi-person me-2"></i>Personal Favorite
          </button>
          <button
            type="button"
            class="dropdown-item"
            (click)="addToFavorites('lab_group')">
            <i class="bi bi-people me-2"></i>Lab Group Favorite
          </button>
          <button
            type="button"
            class="dropdown-item"
            (click)="addToFavorites('global')">
            <i class="bi bi-globe me-2"></i>Global Recommendation
          </button>
        </div>
      </div>
    }
  </div>

  <div class="d-flex gap-2">
    <button type="button" class="btn btn-outline-secondary" (click)="onCancel()">
      <i class="bi bi-x-circle me-1"></i>Cancel
    </button>
    <button
      type="button"
      class="btn btn-primary"
      (click)="onSubmit()"
      [disabled]="editForm.invalid || isLoading()">
      @if (isLoading()) {
        <span class="spinner-border spinner-border-sm me-2"></span>
      }
      <i class="bi bi-check-circle me-1"></i>
      Save Value
    </button>
  </div>
</div>
