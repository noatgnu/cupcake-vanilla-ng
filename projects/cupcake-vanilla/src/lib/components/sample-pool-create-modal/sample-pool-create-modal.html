<div class="modal-header">
  <h4 class="modal-title">
    <i class="bi bi-plus-circle me-2"></i>Create Sample Pool
  </h4>
  <button type="button" class="btn-close" (click)="onCancel()"></button>
</div>

<div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
  <form [formGroup]="createForm" (ngSubmit)="onSubmit()">
    
    <!-- Pool Basic Info -->
    <div class="row mb-4">
      <div class="col-12">
        <h6 class="text-primary mb-3">
          <i class="bi bi-info-circle me-2"></i>Pool Information
        </h6>
      </div>
      
      <!-- Pool Name -->
      <div class="col-md-6 mb-3">
        <label for="poolName" class="form-label">Pool Name *</label>
        <input 
          type="text" 
          class="form-control"
          id="poolName"
          formControlName="poolName"
          [class.is-invalid]="isFieldInvalid('poolName')"
          placeholder="Enter pool name">
        @if (isFieldInvalid('poolName')) {
          <div class="invalid-feedback">
            {{ getFieldError('poolName') }}
          </div>
        }
      </div>


      <!-- Description -->
      <div class="col-12 mb-3">
        <label for="poolDescription" class="form-label">Description</label>
        <textarea 
          class="form-control"
          id="poolDescription"
          formControlName="poolDescription"
          rows="2"
          placeholder="Optional pool description"></textarea>
      </div>

      <!-- Reference Pool Checkbox -->
      <div class="col-12 mb-3">
        <div class="form-check">
          <input 
            class="form-check-input" 
            type="checkbox" 
            id="isReference" 
            formControlName="isReference">
          <label class="form-check-label" for="isReference">
            <strong>Reference Pool</strong>
            <div class="form-text">Check if this is a reference pool</div>
          </label>
        </div>
      </div>
    </div>

    <!-- Sample Selection Methods -->
    <div class="mb-4">
      <h6 class="text-primary mb-3">
        <i class="bi bi-check2-square me-2"></i>Sample Selection
      </h6>

      <!-- Selection Mode Tabs -->
      <div class="btn-group mb-3" role="group">
        <input type="radio" class="btn-check" id="manualMode" [value]="'manual'" 
               [checked]="selectionMode() === 'manual'" (click)="selectionMode.set('manual')">
        <label class="btn btn-outline-primary" for="manualMode">
          <i class="bi bi-hand-index me-1"></i>Manual Selection
        </label>

        <input type="radio" class="btn-check" id="rangeMode" [value]="'range'" 
               [checked]="selectionMode() === 'range'" (click)="selectionMode.set('range')">
        <label class="btn btn-outline-primary" for="rangeMode">
          <i class="bi bi-sliders me-1"></i>Range Selection
        </label>
      </div>

      <!-- Range Selection Controls -->
      @if (selectionMode() === 'range') {
        <div class="card mb-3">
          <div class="card-body">
            <div class="row align-items-end">
              <div class="col-md-4">
                <label for="rangeStart" class="form-label">Start Sample</label>
                <input 
                  type="number" 
                  class="form-control"
                  id="rangeStart"
                  formControlName="range_start"
                  min="1"
                  [max]="metadataTable.sampleCount"
                  [class.is-invalid]="isFieldInvalid('range_start')">
                @if (isFieldInvalid('range_start')) {
                  <div class="invalid-feedback">
                    {{ getFieldError('range_start') }}
                  </div>
                }
              </div>
              <div class="col-md-4">
                <label for="rangeEnd" class="form-label">End Sample</label>
                <input 
                  type="number" 
                  class="form-control"
                  id="rangeEnd"
                  formControlName="range_end"
                  min="1"
                  [max]="metadataTable.sampleCount"
                  [class.is-invalid]="isFieldInvalid('range_end')">
                @if (isFieldInvalid('range_end')) {
                  <div class="invalid-feedback">
                    {{ getFieldError('range_end') }}
                  </div>
                }
              </div>
              <div class="col-md-4">
                <button type="button" class="btn btn-success w-100" (click)="selectSamplesInRange()">
                  <i class="bi bi-plus-square me-1"></i>Select Range
                </button>
              </div>
            </div>
            <div class="form-text mt-2">
              Select samples from {{ createForm.get('range_start')?.value || 1 }} 
              to {{ createForm.get('range_end')?.value || 1 }} 
              ({{ Math.abs((createForm.get('range_end')?.value || 1) - (createForm.get('range_start')?.value || 1)) + 1 }} samples)
            </div>
          </div>
        </div>
      }

      <!-- Sample Table for Manual Selection -->
      @if (selectionMode() === 'manual') {
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">
              Select Samples <span class="text-muted">({{ selectedSamplesCount }} of {{ availableSamplesCount }} selected)</span>
            </label>
            <div class="btn-group btn-group-sm">
              <button
                type="button"
                class="btn btn-outline-primary"
                (click)="selectAllNonPooledSamples()"
                title="Select All"
              >
                <i class="bi bi-check-all"></i>
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary"
                (click)="clearAllSelections()"
                title="Clear Selection"
              >
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th style="width: 50px;">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      [checked]="selectedSamplesCount === availableSamplesCount && selectedSamplesCount > 0"
                      [indeterminate]="selectedSamplesCount > 0 && selectedSamplesCount < availableSamplesCount"
                      (change)="toggleSelectAllSamples()"
                    />
                  </th>
                  <th style="width: 80px;">Sample</th>
                  <th>{{ sourceNameColumn()?.displayName || sourceNameColumn()?.name || 'Source Name' }}</th>
                  <th>{{ assayNameColumn()?.displayName || assayNameColumn()?.name || 'Assay Name' }}</th>
                  <th>{{ labelColumn()?.displayName || labelColumn()?.name || 'Label' }}</th>
                  <th>{{ fractionIdentifierColumn()?.displayName || fractionIdentifierColumn()?.name || 'Fraction Identifier' }}</th>
                </tr>
              </thead>
              <tbody>
                @for (sample of paginatedSamples; track sample.sampleNumber) {
                  <tr
                    [class.table-active]="sample.selected"
                    [class.table-warning]="sample.pooled"
                    (click)="!sample.pooled && toggleSampleSelection(sample.sampleNumber)"
                    [style.cursor]="sample.pooled ? 'not-allowed' : 'pointer'"
                  >
                    <td>
                      <input
                        type="checkbox"
                        class="form-check-input"
                        [checked]="sample.selected"
                        [disabled]="sample.pooled"
                        (click)="$event.stopPropagation()"
                        (change)="toggleSampleSelection(sample.sampleNumber)"
                      />
                    </td>
                    <td class="fw-semibold">
                      {{ sample.sampleNumber }}
                      @if (sample.pooled) {
                        <i class="bi bi-lock-fill ms-1 text-warning" title="Already in another pool"></i>
                      }
                    </td>
                    <td>{{ getColumnValueForSample(sourceNameColumn(), sample.sampleNumber) || '-' }}</td>
                    <td>{{ getColumnValueForSample(assayNameColumn(), sample.sampleNumber) || '-' }}</td>
                    <td>{{ getColumnValueForSample(labelColumn(), sample.sampleNumber) || '-' }}</td>
                    <td>{{ getColumnValueForSample(fractionIdentifierColumn(), sample.sampleNumber) || '-' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          @if (totalPages > 1) {
            <div class="d-flex justify-content-between align-items-center mt-2">
              <small class="text-muted">
                Showing {{ ((currentPage() - 1) * samplesPerPage) + 1 }}-{{ Math.min(currentPage() * samplesPerPage, samples().length) }} of {{ samples().length }}
              </small>
              <ngb-pagination
                [collectionSize]="samples().length"
                [page]="currentPage()"
                [pageSize]="samplesPerPage"
                [maxSize]="3"
                [boundaryLinks]="true"
                (pageChange)="goToPage($event)"
                size="sm"
              ></ngb-pagination>
            </div>
          }

          <div class="form-text">
            <i class="bi bi-info-circle me-1"></i>
            Select samples to add to the pool. Samples with <i class="bi bi-lock-fill"></i> are already in another pool.
          </div>
        </div>
      }

      <!-- Selection Summary -->
      @if (selectedSamplesCount > 0) {
        <div class="alert alert-info">
          <div class="d-flex justify-content-between align-items-center">
            <span>
              <i class="bi bi-info-circle me-2"></i>
              <strong>{{ selectedSamplesCount }}</strong> samples selected
            </span>
            <div class="btn-group btn-group-sm">
              <button type="button" class="btn btn-outline-primary" (click)="assignToPooledOnly()">
                <i class="bi bi-arrow-right me-1"></i>Pooled Only
              </button>
              <button type="button" class="btn btn-outline-success" (click)="assignToPooledAndIndependent()">
                <i class="bi bi-arrow-right me-1"></i>Pooled & Independent
              </button>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Sample Configuration -->
    <div class="mb-4">
      <h6 class="text-primary mb-3">
        <i class="bi bi-gear me-2"></i>Sample Configuration
      </h6>
      
      <!-- Pooled Only Samples -->
      <div class="mb-3">
        <label for="pooledOnlySamples" class="form-label">
          Pooled Only Samples
          <span class="badge bg-primary ms-2">{{ parseSampleNumbers(createForm.get('pooled_only_samples_text')?.value || '').length }} samples</span>
        </label>
        <input 
          type="text" 
          class="form-control"
          id="pooledOnlySamples"
          formControlName="pooled_only_samples_text"
          placeholder="e.g., 1, 2, 3, 5-8">
        <div class="form-text">
          Enter sample numbers separated by commas. Ranges like "5-8" are supported.
        </div>
      </div>

      <!-- Pooled and Independent Samples -->
      <div class="mb-3">
        <label for="pooledAndIndependentSamples" class="form-label">
          Pooled & Independent Samples
          <span class="badge bg-success ms-2">{{ parseSampleNumbers(createForm.get('pooled_and_independent_samples_text')?.value || '').length }} samples</span>
        </label>
        <input 
          type="text" 
          class="form-control"
          id="pooledAndIndependentSamples"
          formControlName="pooled_and_independent_samples_text"
          placeholder="e.g., 4, 9, 10-15">
        <div class="form-text">
          Enter sample numbers that are both pooled and run independently.
        </div>
      </div>

      <!-- Total Count Display -->
      <div class="alert" 
           [class.alert-success]="totalPooledSamplesCount > 0 && totalPooledSamplesCount <= metadataTable.sampleCount"
           [class.alert-warning]="totalPooledSamplesCount === 0"
           [class.alert-danger]="totalPooledSamplesCount > metadataTable.sampleCount">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Total Samples:</strong> {{ totalPooledSamplesCount }}
        @if (totalPooledSamplesCount > metadataTable.sampleCount) {
          <span class="text-danger ms-2">
            (Exceeds maximum of {{ metadataTable.sampleCount }})
          </span>
        } @else if (totalPooledSamplesCount === 0) {
          <span class="text-warning ms-2">
            (Please select at least one sample)
          </span>
        }
      </div>
    </div>

    <!-- Form Status -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <small class="text-muted">
        Name: {{ createForm.get('poolName')?.value?.length || 0 }}/255 characters
      </small>
      @if (totalPooledSamplesCount > 0) {
        <small class="text-success">
          <i class="bi bi-check-circle me-1"></i>Ready to create
        </small>
      }
    </div>

  </form>
</div>

<div class="modal-footer">
  <button type="button" class="btn btn-outline-secondary" (click)="onCancel()">
    <i class="bi bi-x-circle me-1"></i>Cancel
  </button>
  <button 
    type="button" 
    class="btn btn-primary" 
    (click)="onSubmit()"
    [disabled]="createForm.invalid || isLoading() || totalPooledSamplesCount === 0 || totalPooledSamplesCount > metadataTable.sampleCount">
    @if (isLoading()) {
      <span class="spinner-border spinner-border-sm me-2"></span>
    }
    <i class="bi bi-plus-circle me-1"></i>
    Create Pool
  </button>
</div>
