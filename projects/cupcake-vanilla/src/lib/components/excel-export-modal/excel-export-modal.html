<div class="modal-header">
  <h4 class="modal-title">Excel Export Options</h4>
  <button type="button" class="btn-close" aria-label="Close" (click)="cancel()"></button>
</div>

<div class="modal-body">
  <!-- Lab Groups Section -->
  <div class="mb-4">
    <h6 class="fw-semibold mb-3">
      <i class="bi bi-people me-2"></i>Lab Group Recommendations
    </h6>
    
    <div class="form-check mb-2">
      <input 
        class="form-check-input" 
        type="radio" 
        name="includeLabGroups"
        id="labGroups_none"
        [checked]="includeLabGroups() === 'none'"
        (change)="onIncludeLabGroupsChange('none')">
      <label class="form-check-label" for="labGroups_none">
        <strong>None</strong> - Only user-specific and global recommendations
      </label>
    </div>

    <div class="form-check mb-2">
      <input 
        class="form-check-input" 
        type="radio" 
        name="includeLabGroups"
        id="labGroups_selected"
        [checked]="includeLabGroups() === 'selected'"
        (change)="onIncludeLabGroupsChange('selected')">
      <label class="form-check-label" for="labGroups_selected">
        <strong>Selected groups</strong> - Choose specific lab groups
      </label>
    </div>

    <div class="form-check mb-3">
      <input 
        class="form-check-input" 
        type="radio" 
        name="includeLabGroups"
        id="labGroups_all"
        [checked]="includeLabGroups() === 'all'"
        (change)="onIncludeLabGroupsChange('all')">
      <label class="form-check-label" for="labGroups_all">
        <strong>All groups</strong> - Include all available lab group recommendations
      </label>
    </div>

    <!-- Lab Group Selection -->
    @if (showLabGroupSelection()) {
      <div class="border rounded p-3 bg-light">
        @if (isLoadingLabGroups()) {
          <div class="text-center">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Loading lab groups...
          </div>
        } @else if (availableLabGroups().length === 0) {
          <div class="text-muted text-center">
            <i class="bi bi-info-circle me-2"></i>
            No lab groups available
          </div>
        } @else {
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Select Lab Groups:</h6>
            <div class="btn-group btn-group-sm">
              <button 
                type="button" 
                class="btn btn-outline-secondary btn-sm"
                (click)="selectAllLabGroups()"
                [disabled]="selectedLabGroupIds().length === availableLabGroups().length">
                Select All
              </button>
              <button 
                type="button" 
                class="btn btn-outline-secondary btn-sm"
                (click)="deselectAllLabGroups()"
                [disabled]="selectedLabGroupIds().length === 0">
                Clear All
              </button>
            </div>
          </div>

          <div class="row">
            @for (labGroup of availableLabGroups(); track labGroup.id) {
              <div class="col-md-6 mb-2">
                <div class="form-check">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [id]="'labGroup_' + labGroup.id"
                    [checked]="isLabGroupSelected(labGroup.id)"
                    (change)="onLabGroupToggle(labGroup.id, $event.target.checked)">
                  <label class="form-check-label" [for]="'labGroup_' + labGroup.id">
                    {{ labGroup.name }}
                    @if (labGroup.description) {
                      <small class="text-muted d-block">{{ labGroup.description }}</small>
                    }
                  </label>
                </div>
              </div>
            }
          </div>

          @if (selectedLabGroupIds().length > 0) {
            <div class="mt-2">
              <small class="text-success">
                <i class="bi bi-check-circle me-1"></i>
                {{ selectedLabGroupIds().length }} group{{ selectedLabGroupIds().length > 1 ? 's' : '' }} selected
              </small>
            </div>
          }
        }
      </div>
    }
  </div>

  <!-- Pools Section -->
  <div class="mb-4">
    <h6 class="fw-semibold mb-3">
      <i class="bi bi-collection me-2"></i>Sample Pools
    </h6>
    <div class="form-check">
      <input 
        class="form-check-input" 
        type="checkbox" 
        id="includePools"
        [checked]="includePools()"
        (change)="includePools.set($event.target.checked)">
      <label class="form-check-label" for="includePools">
        Include sample pools in export
      </label>
      <small class="form-text text-muted d-block mt-1">
        Creates additional worksheets with pool information and mappings
      </small>
    </div>
  </div>

  <!-- Summary -->
  <div class="alert alert-info">
    <h6 class="alert-heading">
      <i class="bi bi-info-circle me-2"></i>Export Summary
    </h6>
    <ul class="mb-0">
      <li>
        <strong>Lab Groups:</strong>
        @switch (includeLabGroups()) {
          @case ('none') { None - only user and global recommendations }
          @case ('selected') { 
            @if (selectedLabGroupIds().length > 0) {
              {{ selectedLabGroupIds().length }} selected group{{ selectedLabGroupIds().length > 1 ? 's' : '' }}
            } @else {
              No groups selected
            }
          }
          @case ('all') { All available lab groups }
        }
      </li>
      <li><strong>Sample Pools:</strong> {{ includePools() ? 'Included' : 'Excluded' }}</li>
    </ul>
  </div>
</div>

<div class="modal-footer">
  <button type="button" class="btn btn-secondary" (click)="cancel()">
    Cancel
  </button>
  <button 
    type="button" 
    class="btn btn-primary"
    [disabled]="!canConfirm()"
    (click)="confirm()">
    <i class="bi bi-file-earmark-spreadsheet me-2"></i>
    Export Excel
  </button>
</div>
